{% extends "base.html" %}

    {% block title %}
        Dummy title
    {% endblock %}

    {% block additionalstyle %}
    {% endblock %}

    {% block additionaljavascript %}
    {% endblock %}

    {% block content %}
    <style>


      section {
              padding: 20px;
          }
          .container {
              max-width: 1200px;
              margin: 0 auto;
          }
          h2 {
              border-bottom: 1px solid #000;
              padding-bottom: 10px;
          }
          .card {
              border: 1px solid #000;
              padding: 15px;
              margin-bottom: 20px;
          }
          input, select, textarea {
              width: 100%;
              padding: 10px;
              margin: 10px 0;
              border: 1px solid #000;
          }
          button {
              padding: 10px 20px;
              background-color: #000;
              color: #fff;
              border: none;
              cursor: pointer;
          }
          button:hover {
              background-color: #444;
          }
      
          table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 20px;
          }
          table, th, td {
              border: 1px solid #000;
          }
          th, td {
              padding: 10px;
              text-align: left;
          }
      </style>
      
      <div style="display: flex; justify-content: center; align-items: center;" data-bs-theme="dark">
        <div class="card" style="width: 50rem; margin: 30px; padding: 15px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);" data-bs-theme="dark">
          <h5 class="card-header">Persönliche Daten ändern oder löschen indem du die Felder leer absendest.</h5>
          <form class="row g-2" method="POST" action="/profile">
            {{ form.hidden_tag() }}
            <div class="col-md-6">
              {{ form.username }}
            </div>
            <div class="col-md-6">
              {{ form.role }}
            </div>
            <div class="col-md-6">
                {{ form.email }}
            </div>
            <div class="col-md-6">
              {{ form.hs_email }}
            </div>
            <div class="col-md-6">
              {{ form.surname }}
            </div>
            <div class="col-md-6">
              {{ form.lastname }}
            </div>
            <div class="col-md-6">
              {{ form.password }}
            </div>
            <div class="col-md-6">
              {{ form.password_confirm }}
            </div>
            <div class="col-md-4">
              {{ form.street }}
            </div>
            <div class="col-md-2">
              {{ form.street_no }}
            </div>
            <div class="col-md-4">
              {{ form.city }}
            </div>
            <div class="col-md-2">
              {{ form.postalcode }}
            </div>
            <div class="col-12">
              {{ form.submit }}
            </div>
            <div>
              {% with messages = get_flashed_messages() %}
                {% if messages %}
                  <ul class="error-message-list">
                      {% for message in messages %}
                          <p class="error-message">{{ message }}</p>
                      {% endfor %}
                  </ul>
                {% endif %}
              {% endwith %}
            </div>
            <div>
              {% if messages %}
                <ul class="error-message-list">
                    {% for field, message in messages.items() %}
                      <li><strong>{{ field }}</strong>:
                        <ul>
                            {% for msg in message %}
                                <li>{{ msg }}</li>
                            {% endfor %}
                        </ul>
                      </li>
                    {% endfor %}
                </ul>
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      <!-- Personal Calendar Section -->
      <div style="display: flex; justify-content: center; align-items: center;" data-bs-theme="dark">
        <div class="card" style="width: 50rem; margin: 30px; padding: 15px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);" data-bs-theme="dark">
          <h5 class="card-header">Persönlicher Kalender</h5>
          <p class="card-text">Der Kalender enthält alle Events, die du basierend auf deiner Rolle sehen kannst.</p>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="calendar-url" value="{{ url_for('user_calendar_ical', calendar_id=(current_user.calendar_url or ''), _external=True) }}" readonly style="font-family: monospace; font-size: 0.9em; min-height: 35px;">
            <button class="btn btn-outline-secondary d-flex align-items-center justify-content-center" type="button" id="copy-calendar-url" style="min-width: 120px; max-height: 38px;">
              <svg width="16" height="16" fill="currentColor" class="bi bi-clipboard me-1" viewBox="0 0 16 16">
                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
              </svg>
              Kopieren
            </button>
          </div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const roleSelect = document.getElementById('inputRole');
          if (roleSelect) {
            for (let option of roleSelect.options) {
                if (option.value === "{{role}}") {
                    option.selected = true;
                    break;
                }
            }
          }
          const email_color = document.getElementById("email");
          const hs_email_color = document.getElementById("hs_email");
          const emailConfirmed = {{ current_user.email_confirmed | tojson }};
          const hsemailConfirmed = {{ current_user.hs_email_confirmed | tojson }};
          if (emailConfirmed) {
              email_color.style.borderColor = "green";
          }
          if (hsemailConfirmed) {
              hs_email_color.style.borderColor = "green";
          }

          // Calendar URL copy functionality
          const copyButton = document.getElementById('copy-calendar-url');
          if (copyButton) {
            copyButton.addEventListener('click', async function() {
              const url = document.getElementById('calendar-url').value;
              try {
                await navigator.clipboard.writeText(url);
                // Change button text temporarily to show success
                const originalHTML = this.innerHTML;
                this.innerHTML = '<svg width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 0 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> Kopiert!';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-success');
                setTimeout(() => {
                  this.innerHTML = originalHTML;
                  this.classList.remove('btn-success');
                  this.classList.add('btn-outline-secondary');
                }, 2000);
              } catch (err) {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                const originalHTML = this.innerHTML;
                this.innerHTML = '<svg width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 0 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> Kopiert!';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-success');
                setTimeout(() => {
                  this.innerHTML = originalHTML;
                  this.classList.remove('btn-success');
                  this.classList.add('btn-outline-secondary');
                }, 2000);
              }
            });
          }
        });
      </script>
    {% endblock %}
